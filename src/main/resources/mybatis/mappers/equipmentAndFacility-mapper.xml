<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd" >
<mapper namespace="equipmentAndFacilityMapper">

	<resultMap id="EquipmentResultMap" type="EquipmentDto">
		<result column="EQUIP_NO" property="equipNo"/>
		<result column="EQUIP_NAME" property="equipName"/>
		<result column="EQUIP_CATEGORY" property="equipCategory"/>
		<result column="CREATE_DATETIME" property="createDateTime"/>
		<result column="CREATE_USER" property="createUser"/>
		<result column="UPDATE_DATETIME" property="updateDateTime"/>
		<result column="UPDATE_USER" property="updateUser"/>
		<result column="STATUS" property="status"/>				
	</resultMap>

	<resultMap id="FacilityResultMap" type="FacilityDto">
		<result column="FACILITY_NO" property="facilityNo"/>
		<result column="FACILITY_NAME" property="facilityName"/>
		<result column="FACILITY_CATEGORY" property="facilityCategory"/>
		<result column="CREATE_DATETIME" property="createDateTime"/>
		<result column="CREATE_USER" property="createUser"/>
		<result column="UPDATE_DATETIME" property="updateDateTime"/>
		<result column="UPDATE_USER" property="updateUser"/>
		<result column="STATUS" property="status"/>				
	</resultMap>

	<!-- (상우) 비품 카테고리 조회 -->
	<select id="selectEquipmentCategory" resultType="String">
		select DISTINCT EQUIP_CATEGORY
	  	from T_EQUIPMENT
	</select>
	
	<!-- (상우) 시설 카테고리 조회 -->
	<select id="selectFacilityCategory" resultType="String">
		select DISTINCT FACILITY_CATEGORY
		  from T_FACILITY
	</select>
	
	<!-- (상우) 비품 목록 전체 개수 조회 -->
  <select id="selectEquipmentListCount" resultType="_int">
    select
           COUNT(*)
      from T_EQUIPMENT
     where STATUS = 'Y'   
     <if test="equipment != '비품 전체'">
         and EQUIP_CATEGORY = #{equipment}
     </if>   
  </select>

	<!-- (상우) 시설 목록 전체 개수 조회 -->
  <select id="selectFacilityListCount" resultType="_int">
    select
           COUNT(*)
      from T_FACILITY
     where STATUS = 'Y'      
     <if test="facility != '시설 전체'">
         and FACILITY_CATEGORY = #{facility}
     </if>
  </select>

	<!-- (상우) 비품 목록 조회 -->
  <select id="selectEquipmentList" resultMap="EquipmentResultMap">
    select
   				 EQUIP_NO
				 , EQUIP_NAME
				 , EQUIP_CATEGORY
				 , CREATE_DATETIME
				 , CREATE_USER
				 , UPDATE_DATETIME
				 , UPDATE_USER
				 , STATUS
      from T_EQUIPMENT
     where STATUS = 'Y'
		 <if test="equipment != '비품 전체'">
		 	 and EQUIP_CATEGORY = #{equipment}
		 </if>
     order by EQUIP_NO desc
  </select>	
	
	<!-- (상우) 시설 목록 조회 -->
  <select id="selectFacilityList" resultMap="FacilityResultMap">
    select
   				 FACILITY_NO
				 , FACILITY_NAME
				 , FACILITY_CATEGORY
				 , CREATE_DATETIME
				 , CREATE_USER
				 , UPDATE_DATETIME
				 , UPDATE_USER
				 , STATUS
      from T_FACILITY
     where STATUS = 'Y'
		 <if test="facility != '시설 전체'">
		 	 and FACILITY_CATEGORY = #{facility}
		 </if>
     order by FACILITY_NO desc
  </select>	
	
	<!-- (상우) 비품 삭제 -->
	<update id="deleteEquipment">
		update T_EQUIPMENT
		   set STATUS = 'N'
		 where EQUIP_NO IN
		<foreach collection="array" item="equip_no" open="(" separator="," close=")">
    		#{equip_no}
    </foreach>
	</update>
	
	<!-- (상우) 시설 삭제 -->
	<update id="deleteFacility">
		update T_FACILITY
		   set STATUS = 'N'
		<where>
			<foreach collection="array" item="facility_no" open="FACILITY_NO IN (" separator="," close=")">
	    		#{facility_no}
	    </foreach>
    </where>     
	</update>
	
	<!-- (상우) 비품 추가(첨부파일) - (1/2) T_EQUIPMENT 테이블에 INSERT -->
	<insert id="addEquipment">
		insert
			into T_EQUIPMENT
			(
				EQUIP_NO
			, EQUIP_NAME
			, EQUIP_CATEGORY
			, CREATE_DATETIME
			, CREATE_USER
			)
			values
			(
				LPAD(SEQ_ENO.NEXTVAL, 4, '0')
			, #{name}
			, #{selectedCategory}
			, SYSDATE
			, #{userNo}	
			)
	</insert>
	
	<!-- (상우) 비품 추가(첨부파일) - (2/2) T_ATTACHMENT 테이블에 INSERT -->
	<insert id="addAttachment">
		insert
		  into T_ATTACHMENT
		  (
		  	FILE_NO
		  , EQUIP_NO
		  , FILE_PATH
			, FILESYSTEM_NAME
			, ORIGINAL_NAME
			, UPLOAD_DATE
			, REF_TYPE
		  )
		  values
		  (
		  	SEQ_ATNO.NEXTVAL
		  , LPAD(SEQ_ENO.CURRVAL, 4, '0')	
		  , #{filePath}
		  , #{filesystemName}
		  , #{originalName}
		  , SYSDATE
		  , 'E'
		  )
	</insert>
	
	<!-- (상우) 시설 추가 -->
	<insert id="addFacility">
		insert
			into T_FACILITY
			(
				FACILITY_NO
			, FACILITY_NAME
			, FACILITY_CATEGORY
			, CREATE_DATETIME
			, CREATE_USER
			)
			values
			(
				LPAD(SEQ_FNO.NEXTVAL, 4, '0')
			, #{name}
			, #{selectedCategory}
			, SYSDATE
			, #{userNo}	
			)
	</insert>
	
</mapper>
