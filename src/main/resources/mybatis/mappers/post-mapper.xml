<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd" >
<mapper namespace="postMapper">
	    <!-- 결과 매핑 -->
   <resultMap id="postResultMap" type="PostDto">
			<result column="POST_NO" property="postNo" />
			<result column="board_type_no" property="boardTypeNo" />
			<result column="user_no" property="userNo" />
			<result column="USER_NAME" property="writerName" />
			<result column="POST_TITLE" property="postTitle" />
			<result column="POST_CONTENT" property="postContent" />
			<result column="REGIST_DATE" property="registDate" />
			<result column="FILE_STATUS" property="fileStatus" />
			<result column="COUNT" property="count" />
			<result column="POST_TOP" property="postTop" />
			<result column="modify_date" property="modifyDate" />
			<result column="modify_user" property="modifyUser" />
	</resultMap>
	

	<resultMap id="attachResultMap" type="AttachDto">
		<result column="file_no" property="fileNo"/>
		<result column="equipNo" property="equipNo"/>
		<result column="apprNo" property="apprNo"/>
		<result column="file_no" property="fileNo"/>
		<result column="file_path" property="filePath"/>
		<result column="filesystem_name" property="filesystemName"/>
		<result column="original_name" property="originalName"/>
		<result column="POST_NO" property="postNo"/>
	</resultMap>

	<!-- 혹시라도 has a 관계(1:1)일 경우 => collection 대신에 association 으로 사용 -->

	<resultMap id="commentResultMap" type="commentDto">
		<result column="COMMENT_NO" property="commentNo" />
		<result column="USER_NO" property="userNo" />
		<result column="POST_NO" property="postNo" />
		<result column="commentWriter" property="commentWriter" />
		<result column="COMMENTER_ID" property="commenterId" />
		<result column="REF_COMMENT_N0" property="refCommentNo" />
		<result column="REGIST_DATE" property="registDate" />
		<result column="COMMENT" property="comment" />
		<result column="MODIFY_DATE" property="modifyDate" />
		<result column="LEVEL" property="level" />
	</resultMap>

  <!-- 게시글 목록 조회 -->
	<select id="selectPostListCount" resultType="_int">
		select 
					 "count"
			from t_post
		 where file_status = 'Y'
	</select>

	
	<!-- 게시글 목록 조회 -->
	<select id="selectPostList" resultMap="postResultMap">
		select 
      P.POST_NO
    , P.POST_TITLE 
    , USER_NAME 
    , REGIST_DATE
    , FILE_STATUS
    , "COUNT" as count 
    , POST_TOP
  from
      T_POST P
   JOIN 
	    T_USER U 
	ON 
	    P.USER_NO = U.USER_NO    
	ORDER BY 
	    P.POST_NO ASC 
	</select>
	
	<!-- 게시글 등록 -->
<insert id="insertPost">
		insert
			into t_post
			(
				post_no
			, BOARD_TYPE_NO	
			, post_title
			, user_no
			, post_content
			
			)
			  values
		  (
		    'P'||LPAD(SEQ_PNO.NEXTVAL,4,0)
		  , '2'     
		  , #{postTitle}
		  , #{writerName}
		  , #{postContent}
		  )
	</insert> 
	 
	 <!-- 첨부파일 등록 -->
	 <insert id="insertAttach">
	INSERT INTO T_ATTACHMENT 
	(
              FILE_NO,
					    POST_NO,
					    FILE_PATH,
					    FILESYSTEM_NAME,
					    ORIGINAL_NAME,
					    UPLOAD_DATE,
					    REF_TYPE
        )
        VALUES (
            SEQ_ATNO.NEXTVAL,
            'P' || LPAD(SEQ_PNO.CURRVAL, 4, 0),  
            #{filePath},
            #{filesystemName},
            #{originalName},
            SYSDATE,
            #{refType}
        )
    </insert>
	

	
	
	
	<!-- 게시글 상세페이지 조회 -->
	<select id="selectPostDetail" resultMap="postResultMap">
	SELECT
        POST_NO,
        BOARD_TYPE_NO,
        P.USER_NO,
        POST_TITLE,
        POST_CONTENT,
        USER_NAME , 
        USER_ID AS WRITER_ID,     
        "COUNT",
        TO_CHAR(P.REGIST_DATE, 'YYYY-MM-DD') AS REGIST_DATE,
        (
            SELECT COUNT(*)
            FROM T_ATTACHMENT A
            WHERE A.REF_TYPE = 'B'  
              AND A.APPR_NO = #{postNo}
        ) AS ATTACH_COUNT,
        (
           SELECT
           COUNT(*)
           FROM T_LIKE 
           WHERE 
                LIKE_STATUS = 'Y' 
            AND
                POST_NO = #{postNo}
        )AS LIKE_COUNT
				FROM 
				    T_POST P
				JOIN 
				    T_USER U 
				ON 
				    P.USER_NO = U.USER_NO     
				WHERE 
				    p.post_no = #{postNo}
				    
				ORDER BY 
				    P.POST_NO DESC 
				</select>	
				
				<!-- 첨부파일 조회 -->
				<select id="selectAttachList" resultMap="attachResultMap">
					select
				        FILE_NO
				      , FILE_PATH
				      , FILESYSTEM_NAME
				      , ORIGINAL_NAME
				      , POST_NO
				  from  T_ATTACHMENT
				  where POST_NO = #{no}
				</select>
				
				
				<!-- 게시판 조회수 추가 -->
				<update id="updateIncreaseCount">
				  UPDATE T_POST
				  SET COUNT = COUNT + 1
			 where post_no = #{postNo}
				</update>



				<!-- 게시글 댓글 목록조회 -->
				<select id="selectCommentList" resultMap="commentResultMap">
					select
								   comment_no
								 , user_name as "commentWriter"
								 , "COMMENT"
								 , to_char(regist_date, 'YYYY-MM-DD') regist_date
							from t_comment c
							join t_user using (user_no)
						 where post_no = #{postNo}
						 order by comment_no desc
					</select>
					
					
				<!-- 게시글 댓글 등록 -->
			    <insert id="insertComment" >
			        INSERT 
			          INTO T_COMMENT 	
			        	  (
			            	COMMENT_NO
			            , USER_NO
			            , POST_NO
			            , COMMENTER_ID
			            , "COMMENT"
			            , REGIST_DATE
			            , MODIFY_DATE
			        )
			        VALUES (
			           SEQ_CMNO.NEXTVAL
			          , #{userNo}
			          , #{postNo}
			          , #{commentWriter}
			          , #{comment}
			          , SYSDATE
			          , SYSDATE
			        )
			    </insert>
				    
				    
    
    
</mapper>
	
	
	
	<!-- 
  게시글 상세조회
	<select id="selectPostDetail" resultMap="postResultMap">
		SELECT
			    POST_NO,
			    BOARD_TYPE_NO,
			    USER_NO,
			    POST_TITLE,
			    POST_CONTENT,
			    USER_NAME AS WRITER_NAME,  작성자 이름 (USER_NAME 사용)
			    USER_ID AS WRITER_ID,      작성자 ID (USER_ID 사용)
			    "COUNT",
			    TO_CHAR(P.REGIST_DATE, 'YYYY-MM-DD') AS REGIST_DATE, 작성일 형식 변환
			    (
			        SELECT COUNT(*)
			        FROM ATTACHMENT A
			        WHERE A.REF_TYPE = 'B'  
			          AND A.FILE_NO = P.POST_NO
			    ) AS ATTACH_COUNT
FROM 
    T_POST P
JOIN 
    T_USER U 
ON 
    P.USER_NO = U.USER_NO         USER_NO로 작성자와 JOIN 
WHERE 
    P_STATUS = 'Y'                게시글 상태가 'Y'인 데이터만 조회
    user_no = #{userNo}
ORDER BY 
    P.POST_NO DESC;               게시글 번호 내림차순 정렬

	</select> 
	 -->
	
	<!-- 게시글 상세 페이지 조회 -->
	
	<!-- <select id="selectPostDetail" resultMap="postResultMap" >
		  SELECT 
            POST_NO as postNo,
            POST_TITLE as postTitle,
            POST_CONTENT as postContent,
            POST_WRITER as postWriter,
            REGIST_DT as registDate
        FROM 
            T_POST
        WHERE 
            POST_NO = #{postNo}
	</select> -->
	
	

    
	
	

