<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd" >
<mapper namespace="holimapper">
	
	
	<resultMap id="holiResultMap" type="WorkStatusDto"> 
	<result column="USER_NO" property="userNo"/>
	<result column="AR_DATE" property="arDate"/>
	<result column="WEEKEND_DATE" property="weekendDate"/>
	<result column="AR_TIME" property="arTime"/>
	<result column="AR_AV" property="arAv"/>
	<result column="WEEKEND_TIME" property="weekendTime"/>
	<result column="work_STATUS" property="workStatus"/>
	</resultMap>
	 <resultMap id="commuteResultMap" type="CommuteDto">
   <result column="user_NO" property="userNo"/>
   <result column="user_name" property="userName"/>
   <result column="WORK_IN" property="workIn"/>
   <result column="WORK_OUT" property="workOut"/>
   <result column="IN_STATUS" property="inStatus"/>
   <result column="OUT_STATUS" property="outStatus"/>
   <result column="HOLIDAY" property="holiday"/>
   </resultMap>
	<select id="selectworkStatus" resultMap="holiResultMap">
			select *
			from T_ATTENDANCE_RECORD
			where user_no = #{userNo}
	</select>
	     <insert id="insertCheckIn" parameterType="commuteResultMap">
        MERGE INTO T_COMMUTE AS target
        USING (
            SELECT #{userNo} AS USER_NO, #{userName} AS USER_NAME FROM DUAL
        ) AS source
        ON (target.USER_NO = source.USER_NO)
        WHEN MATCHED THEN
            UPDATE SET 
                WORK_IN = CURRENT_TIMESTAMP,
                IN_STATUS = 'Y'
        WHEN NOT MATCHED THEN
            INSERT (USER_NO, USER_NAME, WORK_IN, IN_STATUS)
            VALUES (source.USER_NO, source.USER_NAME, CURRENT_TIMESTAMP, 'Y');
    </insert>
   <update id="updateCheckOut">
    UPDATE T_COMMUTE
    SET 
        WORK_OUT = CURRENT_TIME,
        OUT_STATUS = 'Y',
        HOLIDAY = HOLIDAY + TIMESTAMPDIFF(MINUTE, WORK_IN, CURRENT_TIME),
        WORK_DAYS = WORK_DAYS + 1
    WHERE USER_NO = #{userNo};

    UPDATE T_ATTENDANCE_RECORD
    SET 
        AR_TIME = AR_TIME + TIMESTAMPDIFF(MINUTE, WORK_IN, CURRENT_TIME),
        AR_DATE = AR_DATE + 1,
        AR_AV = (AR_TIME + TIMESTAMPDIFF(MINUTE, WORK_IN, CURRENT_TIME)) / (AR_DATE + 1)
    WHERE USER_NO = #{userNo};
   </update>
   
</mapper>