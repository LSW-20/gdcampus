<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd" >
<mapper namespace="approvalMapper">

	<resultMap id="approvalResultMap" type="ApprovalDto">
		<result column="APPR_NO" property="apprNo"/>
		<result column="APPR_USER" property="apprUser"/>
		<result column="DEPT_NO" property="deptNo"/>
		<result column="APPR_TYPE" property="apprType"/>
		<result column="APPR_DATE" property="apprDate"/>
		<result column="APPR_TITLE" property="apprTitle"/>
		<result column="APPR_CONTENT" property="apprContent"/>
		<result column="CURR_ORDER" property="currOrder"/>
		<result column="APPR_STATUS" property="apprStatus"/>
		<result column="CREATE_DATE" property="createDate"/>
		<result column="CREATE_USER" property="createUser"/>
		<result column="MODIFY_DATE" property="modifyDate"/>
		<result column="UPDATE_USER" property="updateUser"/>	
		
		<result column="USER_NAME" property="userName"/>
		<result column="DEPT_NAME" property="deptName"/>
		<result column="RANK_NAME" property="rankName"/>		
		
    <!-- 문서 타입별 association(1 : 1) 매핑 추가 -->
    <association property="draft" javaType="DraftDto">
        <result column="ENFORCE_DATE" property="enforceDate"/>
        <result column="COOP_DEPT" property="coopDept"/>
    </association>		
    <association property="purchDraft" javaType="PurchaseDraftDto">
        <result column="PURCH_DEPT" property="purchDept"/>
        <result column="PURCH_EMP_NAME" property="purchEmpName"/>
        <result column="PURCH_PURPOSE" property="purchPurpose"/>
        <result column="PURCH_DEADLINE" property="purchDeadline"/>
        <result column="PURCH_TOTAL" property="purchTotal"/>
				
				<!-- 물품목록 -->
        <collection property="purchaseItems" ofType="PurchaseHistoryDto">
            <result column="PRODUCT_NO" property="productNo"/>
            <result column="PRODUCT_NAME" property="productName"/>
            <result column="PRODUCT_UNIT" property="productUnit"/>
            <result column="PRODUCT_AMT" property="productAmt"/>
            <result column="PRODUCT_PRICE" property="productPrice"/>
        </collection>
    </association>
    
		<!-- 결재선 정보 collection 매핑 추가 -->
		<collection property="approvers" ofType="ApprLineDto">
			<result column="LINE_NO" property="lineNo"/>
			<result column="APPR_NO" property="apprNo"/>
			<result column="USER_NO" property="userNo"/>
			<result column="LINE_ORDER" property="lineOrder"/>
			<result column="LINE_STATUS" property="lineStatus"/>
			<result column="LINE_DATE" property="lineDate"/>
			<result column="LINE_REASON" property="lineReason"/>
			<result column="CREATE_DATE" property="createDate"/>
			<result column="CREATE_USER" property="createUser"/>
			<result column="MODIFY_DATE" property="modifyDate"/>
			<result column="MODIFY_USER" property="modifyUser"/>
			
			
			<result column="USER_NAME" property="userName"/>
			<result column="DEPT_NAME" property="deptName"/>
			<result column="RANK_NAME" property="rankName"/>
		</collection>	    
    		
	</resultMap>
	
	<resultMap id="apprRefResultMap" type="ApprRefDto">
		<result column="REF_NO" property="refNo"/>
		<result column="APPR_NO" property="apprNo"/>
		<result column="USER_NO" property="userNo"/>
		<result column="REF_TYPE" property="refType"/>
		<result column="READ_YN" property="readYn"/>
		<result column="READ_DATE" property="readDate"/>
		<result column="CREATE_DATE" property="createDate"/>
		<result column="CREATOR" property="creator"/>
		<result column="MODIFY_DATE" property="modifyDate"/>
		<result column="MODIFY_USER" property="modifyUser"/>
	</resultMap>
	

	
	<!-- 결재대기문서함페이징 -->
	<select id="selectApprTodoListCount" resultType="_int">
		SELECT
		       COUNT(*)
		  FROM T_APPROVAL A
		  JOIN T_APPR_LINE L
		    ON A.APPR_NO = L.APPR_NO
		 WHERE APPR_STATUS = 1					<!-- 진행중 -->
		   AND LINE_ORDER = CURR_ORDER  <!-- 현재결재순서 -->
		   AND USER_NO = #{userNo}		  <!-- LOGINUSER -->  	
	</select>
	
	<!-- 결재대기문서함 -->
  <select id="selectApprTodoList" resultMap="approvalResultMap">
		SELECT
		       A.APPR_NO as APPR_USER
		     , APPR_USER
		     , DEPT_NO
		     , APPR_TYPE
		     , APPR_DATE
		     , APPR_TITLE
		     , APPR_CONTENT
		     , CURR_ORDER
		     , LINE_ORDER
		     , APPR_STATUS
		     , LINE_NO
		     , USER_NO 
		     , LINE_STATUS
		     , LINE_DATE
		     , LINE_REASON
		  FROM T_APPROVAL A
		  LEFT JOIN T_APPR_LINE L
		    ON A.APPR_NO = L.APPR_NO
		 WHERE APPR_STATUS = 1					<!-- 진행중 -->
		   AND LINE_ORDER = CURR_ORDER  <!-- 현재결재순서 -->
		   AND USER_NO = #{userNo}		  <!-- LOGINUSER -->  
  </select>
  
  <!-- 결재예정문서 페이징 -->
  <select id="selectApprUpcomingListCount" resultType="_int">
		SELECT
		       COUNT(A.APPR_NO)  
		  FROM T_APPROVAL A
		  JOIN T_APPR_LINE L
		    ON A.APPR_NO = L.APPR_NO
		 WHERE APPR_STATUS IN(0,1)      <!-- 대기/진행중 -->
		   AND L.USER_NO = #{userNo} 						 <!-- LOGINUSER   -->	
		   AND CURR_ORDER &lt; LINE_ORDER      <!-- 현재결재순서 -->		       
  </select>
  
  <!-- 결재예정문서 -->
  <select id="selectApprUpcomingList" resultMap="approvalResultMap">
		SELECT A.APPR_NO as APPR_NO
		     , APPR_USER
		     , DEPT_NO
		     , APPR_TYPE
		     , APPR_DATE
		     , APPR_TITLE
		     , APPR_CONTENT
		     , APPR_STATUS
		     , CURR_ORDER
		     , LINE_NO
		     , L.USER_NO
		     , LINE_ORDER
		     , LINE_STATUS
		     , LINE_DATE
		     , LINE_REASON
		  FROM T_APPROVAL A
		  JOIN T_APPR_LINE L
		    ON A.APPR_NO = L.APPR_NO
		 WHERE APPR_STATUS IN(0,1)      <!-- 대기/진행중 -->
		   AND L.USER_NO = #{userNo} 						 <!-- LOGINUSER   -->	
		   AND CURR_ORDER &lt; LINE_ORDER      <!-- 현재결재순서 -->
  </select>
  
  <!-- 기안문서함페이징 -->
  <select id="selectMyDocListCount" parameterType="map" resultType="_int">
  	SELECT
  				 COUNT(APPR_NO)
  		FROM T_APPROVAL
  	 WHERE APPR_USER = #{userNo}
  	 <if test="status != null and status !=''">
  	 		AND APPR_STATUS = #{status}
  	 </if>
  </select>
  
  <!-- 기안문서함 -->
  <select id="selectMyDocList" resultMap="approvalResultMap">
		SELECT 
		       APPR_NO
		     , APPR_USER
		     , APPR_TYPE
		     , APPR_TITLE
		     , DEPT_NO
		     , APPR_DATE
		     , APPR_STATUS
		     , CREATE_DATE
		     , MODIFY_DATE
		     , UPDATE_USER
		     <!-- , (SELECT COUNT(*) FROM T_ATTACHMENT WHERE APPR_NO = A.APPR_NO) AS ATTACH_COUNT -->
		  FROM T_APPROVAL
		 WHERE APPR_USER = #{userNo}	
		 <if test="status != null and status !=''">
		 		AND APPR_STATUS = #{status}
		 </if>
		 ORDER
		    BY APPR_DATE DESC
  </select>
  
  <!-- 결재문서함 -->
  <select id="selectMyApprovedList" resultMap="approvalResultMap">
		SELECT 
		       A.APPR_NO as APPR_NO
		     , APPR_USER
		     , DEPT_NO
		     , APPR_TYPE
		     , APPR_DATE
		     , APPR_TITLE
		     , APPR_CONTENT
		     , APPR_STATUS
		     , LINE_NO
		     , USER_NO 
		     , LINE_ORDER
		     , LINE_STATUS
		     , LINE_DATE
		     , LINE_REASON
		  FROM T_APPROVAL A
		  LEFT JOIN T_APPR_LINE L
		    ON A.APPR_NO = L.APPR_NO
		 WHERE USER_NO = #{userNo}  <!-- LOGINUSER -->
		   AND APPR_STATUS IN(2,3)  	
  </select>
  
  <!-- 참조/열람대기문서함 -->
  <select id="selectApprViewerList" resultMap="apprRefResultMap">
		SELECT 
		       REF_NO
		     , R.APPR_NO
		     , USER_NO
		     , REF_TYPE
		     , READ_YN
		     , READ_DATE
		  FROM T_APPR_REF R
		  JOIN T_APPROVAL A
		    ON R.APPR_NO = A.APPR_NO
		 WHERE USER_NO = #{userNo}    <!-- LOGINUSER -->
		   AND APPR_STATUS IN(0,1)  <!-- 대기/진행 상태 -->
  </select>
  
  <!-- 결재대기문서상세 -->
  <select id="selectApprTodoDetail" resultMap="approvalResultMap">
		SELECT 
		       A.APPR_NO AS APPR_NO
		     , APPR_USER
		     , DEPT_NO
		     , APPR_TYPE
		     , APPR_DATE
		     , APPR_TITLE
		     , APPR_CONTENT
		     , APPR_STATUS
		     , LINE_NO
		     , L.USER_NO as USER_NO
		     , LINE_ORDER
		     , LINE_STATUS
		     , LINE_DATE
		     , LINE_REASON
		  FROM T_APPROVAL A
		  LEFT JOIN T_APPR_LINE L
		    ON A.APPR_NO = L.APPR_NO
		 WHERE USER_NO = #{userNo}    <!-- LOGINUSER 가져오거나 INTERCEPTOR추가하거나-->
		   AND APPR_STATUS IN(2,3)    <!-- 승인,반려 -->
		   AND A.APPR_NO = #{apprNo}  <!-- 상세로 불러올 문서번호 요청 -->  
  </select>
  
  <!-- 결재예정문서 상세 -->
  <select id="selectApprUpcomingDetail" resultMap="approvalResultMap">
		SELECT A.APPR_NO as APPR_NO
		     , APPR_USER
         , U.USER_NAME as USER_NAME
		     , DEPT_NO
         , D.DEPT_NAME as DEPT_NAME
         , R.RANK_NAME as RANK_NAME
		     , APPR_TYPE 
		     , APPR_DATE
		     , APPR_TITLE
		     , APPR_CONTENT
		     , APPR_STATUS
		     , CURR_ORDER
		     , LINE_NO
		     , L.USER_NO
		     , LINE_ORDER
		     , LINE_STATUS
		     , LINE_DATE
		     , LINE_REASON
		  FROM T_APPROVAL A
		  JOIN T_APPR_LINE L
		    ON A.APPR_NO = L.APPR_NO
          JOIN T_USER U
            ON U.USER_NO = APPR_USER
          JOIN T_RANK R 
            ON R.RANK_NO = U.RANK_NO
          JOIN T_DEPT D
            ON D.DEPT_NO = U.DEPT_NO
		 WHERE APPR_STATUS IN(0,1)      <!-- 대기/진행중 -->
		   AND L.USER_NO = #{userNo}      <!-- LOGINUSER -->
		   AND CURR_ORDER &lt; LINE_ORDER   <!-- 현재결재순서  -->   
		   AND A.APPR_NO = #{apprNo}   <!--  문서번호  -->   
  </select>


	<!-- 기안문서상세 -->
	<select id="selectMyDocDetail" resultMap="approvalResultMap">
		SELECT 
		       APPR_NO
		     , APPR_USER
		     , DEPT_NO
		     , APPR_DATE
		     , APPR_CONTENT
		     , APPR_STATUS
		     , CREATE_DATE
		     , MODIFY_DATE
		     , UPDATE_USER
		  FROM T_APPROVAL
		 WHERE APPR_USER = #{userNo}	
  	   AND APPR_NO = #{apprNo}
	</select>	
	
	<!-- 결재문서 상세 -->
	<select id="selectMyApprovedDetail" resultMap="approvalResultMap">
		SELECT 
		       A.APPR_NO as APPR_NO
		     , APPR_USER
		     , DEPT_NO
		     , APPR_TYPE
		     , APPR_DATE
		     , APPR_TITLE
		     , APPR_CONTENT
		     , APPR_STATUS
		     , LINE_NO
		     , USER_NO 
		     , LINE_ORDER
		     , LINE_STATUS
		     , LINE_DATE
		     , LINE_REASON
		  FROM T_APPROVAL A
		  LEFT JOIN T_APPR_LINE L
		    ON A.APPR_NO = L.APPR_NO
		 WHERE USER_NO = #{userNo}  <!-- LOGINUSER -->
		   AND APPR_STATUS IN(2,3)
		   AND A.APPR_NO = #{apprNo}	
	</select>	

	<!-- 진행중 기안문서 최근 5개 가져오기 -->
	<select id="getRecentInProgressDocs" resultMap="approvalResultMap">
		WITH MY_DOC_LIST AS(
		SELECT
		       A.APPR_NO 
		     , A.APPR_USER 
		     , A.APPR_TYPE 
		     , A.APPR_DATE 
		     , A.APPR_TITLE
		     , A.CURR_ORDER 
		     , A.APPR_STATUS
		  FROM T_APPROVAL A
		 WHERE A.APPR_STATUS = 1
		   AND A.APPR_USER = #{userNo}
		 ORDER 
		    BY A.APPR_DATE DESC  
		)
		SELECT 
		       APPR_NO 
		     , APPR_USER 
		     , APPR_TYPE 
		     , APPR_DATE 
		     , APPR_TITLE 
		     , CURR_ORDER 
		     , APPR_STATUS 
		  FROM MY_DOC_LIST A
		 <![CDATA[
		 WHERE ROWNUM <= 5
		 ]]>
	</select>
	
	<select id="getRecentCompletedDocs" resultMap="approvalResultMap">
		WITH MY_DOC_LIST AS(
		SELECT
		       A.APPR_NO 
		     , A.APPR_USER 
		     , A.APPR_TYPE 
		     , A.APPR_DATE 
		     , A.APPR_TITLE
		     , A.CURR_ORDER 
		     , A.APPR_STATUS
		  FROM T_APPROVAL A
		 WHERE A.APPR_STATUS IN(2,3)
		   AND A.APPR_USER = #{userNo}
		 ORDER 
		    BY A.APPR_DATE DESC  
		)
		SELECT 
		       APPR_NO 
		     , APPR_USER 
		     , APPR_TYPE 
		     , APPR_DATE 
		     , APPR_TITLE 
		     , CURR_ORDER 
		     , APPR_STATUS 
		  FROM MY_DOC_LIST A
		 <![CDATA[
		 WHERE ROWNUM <= 5
		 ]]>	
	</select>
	
	<insert id="insertApproval">
		INSERT 
		  INTO T_APPROVAL 
		(
		    APPR_NO
		  , APPR_USER
		  , DEPT_NO
		  , APPR_TYPE
		  , APPR_DATE
		  , APPR_TITLE
		  , APPR_CONTENT
		  , CURR_ORDER
		  , APPR_STATUS
		  , CREATE_DATE
		  , CREATE_USER
		) VALUES 
		(
		    LPAD(SEQ_ANO.NEXTVAL, 4, '0')
		  , #{apprUser}
		  , #{deptNo}
		  , #{apprType}
		  , SYSDATE
		  , #{apprTitle}
		  , #{apprContent}
		  , 2
		  , 0
		  , SYSDATE
		  , #{apprUser}
		)	
	</insert>
	
	<insert id="insertApprovalLine">
		INSERT 
		  INTO T_APPR_LINE 
	  (
		    LINE_NO
		  , APPR_NO
		  , USER_NO
		  , LINE_ORDER
		  , LINE_STATUS
		  , CREATE_DATE
		  , CREATE_USER
		) 
	  VALUES 
		(
		    SEQ_ALNO.NEXTVAL
		  , LPAD(SEQ_ANO.CURRVAL, 4, '0')
		  , #{userNo}
		  , #{lineOrder}
		  , 0
		  , SYSDATE
		  , #{createUser}
		)	
	</insert>
	
	<!-- 기안서 등록 -->
	<insert id="insertSimpleDraft">
	   INSERT 
	     INTO T_DRAFT 
	   (
	       APPR_NO
	     , ENFORCE_DATE
	     , COOP_DEPT
	   ) 
	   VALUES 
	   (
	       LPAD(SEQ_ANO.CURRVAL, 4, '0')
	     , #{enforceDate}
	     , #{coopDept}
	   )
	</insert>
	
	<!-- 품의서 등록 -->
	<insert id="insertPurchDraft">
	   INSERT 
	     INTO T_PURCH_DRAFT 
	   (
	       APPR_NO
	     , PURCH_DEPT
	     , PURCH_EMP_NAME
	     , PURCH_PURPOSE
	     , PURCH_DEADLINE
	     , PURCH_TOTAL
	   ) 
	   VALUES 
	   (
	       LPAD(SEQ_ANO.CURRVAL, 4, '0')
	     , #{purchDept}
	     , #{purchEmpName}
	     , #{purchPurpose}
	     , #{purchDeadline}
	     , #{purchTotal}
	   )
	</insert>
	
	<!-- 품의서 물품 등록 -->
	<insert id="insertPurchaseHistory">
	   INSERT 
	     INTO T_PURCH_HISTORY 
	   (
	       APPR_NO
	     , PRODUCT_NO
	     , PRODUCT_NAME
	     , PRODUCT_UNIT
	     , PRODUCT_AMT
	     , PRODUCT_PRICE
	   ) 
	   VALUES 
	   (
	       LPAD(SEQ_ANO.CURRVAL, 4, '0')
	     , #{productNo}
	     , #{productName}
	     , #{productUnit}
	     , #{productAmt}
	     , #{productPrice}
	   )
	</insert>	
	
	<select id="selectApproversList" resultMap="approvalResultMap">
		SELECT LINE_NO
		     , L.APPR_NO as APPR_NO
		     , L.USER_NO as USER_NO
		     , U.USER_NAME as USER_NAME
		     , D.DEPT_NAME as DEPT_NAME
		     , R.RANK_NAME as RANK_NAME
		     , LINE_ORDER
		     , LINE_STATUS
		     , LINE_DATE
		     , LINE_REASON
		     , L.CREATE_DATE as CREATE_DATE
		     , L.CREATE_USER as CREATE_USER
		  FROM T_APPR_LINE L
		  JOIN T_APPROVAL A
		    ON A.APPR_NO = L.APPR_NO
		  JOIN T_USER U
		    ON L.USER_NO = U.USER_NO
		  JOIN T_DEPT D
		    ON U.DEPT_NO = D.DEPT_NO
		  JOIN T_RANK R
		    ON U.RANK_NO = R.RANK_NO
		 WHERE L.APPR_NO = #{apprNo}
	</select>
	
</mapper>
